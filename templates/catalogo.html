<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <title>Mai Essências e Aromas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Catálogo de produtos Mai Essências e Aromas.">
    <meta name="keywords" content="essencias, aromas, via aroma, Mai Essências e Aromas">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
      body {
        background-color: #fef0f5; /* Fundo rosa bem claro */
      }
      .navbar {
        /* background-color: #000000; */ /* Original */
        background-color: #E91E63; /* COR PRINCIPAL ROSA */
      }
      .navbar-brand img {
        width: 50px;
        height: auto;
      }
      .navbar-brand {
        /* color: #FFD700; */ /* Original */
        color: #ffffff; /* Branco para contraste com rosa */
      }
      .navbar-brand:hover {
        /* color: #FFDD44; */ /* Original */
        color: #F8BBD0; /* Rosa claro no hover */
      }
      .navbar-nav .nav-link {
        /* color: #fff; */ /* Original */
        color: #ffffff;
      }
      .navbar-nav .nav-link:hover {
        /* color: #FFD700; */ /* Original */
        color: #F8BBD0; /* Rosa claro no hover */
      }
      .navbar-nav .nav-item {
        margin-right: 15px;
      }

      /* ===== PRODUTOS ===== */
      .container .row {
        --bs-gutter-x: 0.1rem;
        --bs-gutter-y: 0.1rem;
        margin-left: -0.05rem;
        margin-right: -0.05rem;
      }

      .col-lg-3, .col-md-6, .col-6 {
        padding-left: 0.05rem !important;
        padding-right: 0.05rem !important;
      }

      .produto-card {
        margin: 0;
        transition: transform 0.2s ease-in-out;
        border: 1px solid #dee2e6;
        height: 100%;
      }

      .produto-card:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .produto-imagem {
        width: 100%;
        height: 250px;
        object-fit: contain;
        padding: 2px;
        background-color: #fff;
      }

      .card-body {
        padding: 12px;
      }

      .card-title {
        font-size: 0.95rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 0.3rem;
      }

      /* ===== SLIDER ===== */
      .hero-slider {
        padding: 80px 0;
        /* background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); */ /* Original */
        background: linear-gradient(135deg, #D81B60 0%, #FF80AB 100%); /* Gradiente Rosa */
        border-radius: 15px;
        margin: 15px auto;
        width: calc(100% - 30px);
        max-width: 1400px;
        position: relative;
        left: 50%;
        transform: translateX(-50%);
        min-height: 400px;
      }

      .carousel-caption {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 1200px;
        padding: 20px;
      }

      .hero-slider h1 {
        font-size: 2.8rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      }

      .hero-slider .lead {
        font-size: 1.5rem;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }

      /* Overrides Bootstrap */
      .btn-primary {
        background-color: #E91E63 !important;
        border-color: #E91E63 !important;
        color: #fff !important;
      }
      .btn-primary:hover, .btn-primary:focus {
        background-color: #D81B60 !important; /* Rosa mais escuro */
        border-color: #D81B60 !important;
        color: #fff !important;
        box-shadow: none !important;
      }
       .btn-outline-primary {
         color: #E91E63 !important;
         border-color: #E91E63 !important;
       }
       .btn-outline-primary:hover {
         background-color: #E91E63 !important;
         border-color: #E91E63 !important;
         color: #fff !important;
       }
       .text-primary {
           color: #E91E63 !important;
       }
       .btn-outline-success { /* Botão de busca */
          color: #E91E63 !important;
          border-color: #E91E63 !important;
       }
       .btn-outline-success:hover {
           background-color: #E91E63 !important;
           border-color: #E91E63 !important;
           color: #fff !important;
       }
       .badge.bg-danger { /* Contador do carrinho */
           background-color: #D81B60 !important; /* Rosa escuro para destaque */
       }
        .page-item.active .page-link { /* Paginação */
          background-color: #E91E63 !important;
          border-color: #E91E63 !important;
        }
        .page-link {
          color: #E91E63 !important;
        }
        .page-link:hover {
           color: #D81B60 !important;
           background-color: #fce4ec !important; /* Fundo rosa bem claro no hover */
        }

      /* ===== RESPONSIVO ===== */
      @media (max-width: 575.98px) {
        .col-6 {
          flex: 0 0 49.95%;
        }
        .produto-imagem {
          height: 180px;
        }
        .hero-slider {
          min-height: 250px;
          padding: 40px 0;
        }
        .hero-slider h1 {
          font-size: 1.8rem;
        }
        .hero-slider .lead {
          font-size: 1.1rem;
        }
      }

      @media (min-width: 576px) and (max-width: 991.98px) {
        .col-md-6 {
          flex: 0 0 49.95%;
        }
        .produto-imagem {
          height: 220px;
        }
        .hero-slider h1 {
          font-size: 2.2rem;
        }
      }

      @media (min-width: 992px) {
        .col-lg-3 {
          flex: 0 0 24.95%;
        }
        .produto-imagem {
          height: 280px;
        }
      }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WXB72Z2D6X"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-WXB72Z2D6X');
    </script>
  </head>
  <body>


    <nav class="navbar navbar-expand-lg"> <div class="container-fluid">
        <a class="navbar-brand" href="/" aria-label="Voltar para a página inicial">
          <img src="http://ofertacobrasil.com.br/ofertaco/empresas/LOGO%20SEM%20FUNDO.png" alt="Logo Mai Essências e Aromas">
          Mai Essências e Aromas
        </a>

        <a class="nav-link position-relative me-3 d-lg-none" href="/carrinho" aria-label="Carrinho de compras">
          {# Usei rosa claro para o ícone do carrinho para contraste com a navbar rosa #}
          <i class="bi bi-cart3" style="font-size: 1.2rem; color: #F8BBD0;"></i>
          {# Usa a variável injetada globalmente pelo context_processor #}
          {% if cart_total_items > 0 %}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              {{ cart_total_items }}
            </span>
          {% endif %}
        </a>

        <form class="search-form d-flex order-lg-2 mx-2 flex-grow-1" method="GET" action="/">
            <div class="input-group">
              <input class="form-control form-control-sm" type="search" placeholder="Buscar produto" aria-label="Buscar" name="search" value="{{ request.args.get('search', '') }}">
              <button class="btn btn-outline-success btn-sm" type="submit">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>

        <div class="order-lg-3 me-3 d-none d-lg-block">
          <a class="nav-link position-relative" href="/carrinho" aria-label="Carrinho de compras">
            <i class="bi bi-cart3" style="font-size: 1.2rem; color: #F8BBD0;"></i>
             {# Usa a variável injetada globalmente pelo context_processor #}
            {% if cart_total_items > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ cart_total_items }}
              </span>
            {% else %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-counter" style="display: none;">0</span>
            {% endif %}
          </a>
        </div>

        <div class="d-flex align-items-center order-lg-4">
          {% if current_user.is_authenticated %}
            <div class="dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle" style="color: #F8BBD0;"></i>
                {# Acessa o nome do usuário logado #}
                {{ current_user.nome }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('perfil') }}"><i class="bi bi-person"></i> Meu Perfil</a></li>
                <li><a class="dropdown-item" href="{{ url_for('listar_pedidos') }}"><i class="bi bi-receipt"></i> Meus Pedidos</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
              </ul>
            </div>
          {% else %}
            <div class="d-flex gap-2">
              <a class="btn btn-outline-primary btn-sm" href="{{ url_for('login') }}"><i class="bi bi-box-arrow-in-right"></i> Login</a>
              <a class="btn btn-primary btn-sm" href="{{ url_for('registrar') }}"><i class="bi bi-person-plus"></i> Registrar</a>
            </div>
          {% endif %}
        </div>

        <button class="navbar-toggler order-lg-5" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon" style="background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.75)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e\");"></span> </button>
      </div>
    </nav>

<div class="ticker-container" style="margin: 0; padding: 0; line-height: 1;">
  <div id="tickerCarousel"
       class="carousel slide carousel-fade"
       data-bs-ride="carousel"
       data-bs-interval="9000"
       style="margin: 0; padding: 0; border: none; background-color: #F8BBD0;"> <div class="carousel-inner" style="margin: 0; padding: 0;">
      {% for slide in slides %}
        <div class="carousel-item {% if loop.first %}active{% endif %}"
             style="margin: 0; padding: 0; border: none;">

          <div class="d-flex justify-content-center align-items-center"
               style="height: 40px; text-align: center;">
            <small class="ticker-text"
                   style="font-size: 1.2rem; color: #D81B60;"> {{ slide.titulo }}
            </small>
          </div>

        </div>
      {% endfor %}
    </div>
  </div>
</div>


    <div class="container pt-3">

      {# Exibe a mensagem específica de busca sem resultados, se existir #}
      {% if message %}
        <div class="alert alert-warning text-center" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ message }}
        </div>
      {% endif %}

      <div class="row">
        {# Loop para exibir os produtos #}
        {% for produto in produtos %}
        <div class="col-lg-3 col-md-6 col-6 mb-4">
          <div class="card produto-card h-100 shadow-sm">
            {% if produto.imagemURL %}
            <a href="{{ url_for('product_detail', codigo=produto.codigo) }}">
              <img src="{{ url_for('proxy_image', url=produto.imagemURL) }}" alt="{{ produto.nome }}" class="produto-imagem" loading="lazy" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/sem-imagem.jpg') }}';">
            </a>
            {% else %}
            <a href="{{ url_for('product_detail', codigo=produto.codigo) }}">
              <img src="{{ url_for('static', filename='images/sem-imagem.jpg') }}" alt="Imagem não disponível" class="produto-imagem" loading="lazy">
            </a>
            {% endif %}
            <div class="card-body d-flex flex-column"> {# Adicionado d-flex flex-column #}
                <h5 class="card-title">{{ produto.nome }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">Código: {{ produto.codigo }}</h6>
                <p class="card-text mb-2"><strong>Preço:</strong> {{ produto.preco | brl }}</p> {# mb-2 em vez de mb-3 #}
                <p class="card-text mb-3" data-produto-id="{{ produto.id }}"> {# mb-3 aqui #}
                  <strong>Status:</strong>
                  <span class="badge
                    {% if produto['estoque']['saldoVirtualTotal'] > 0 %}bg-success{% else %}bg-danger text-white{% endif %}"> {# Manter cores de status originais #}
                    {% if produto['estoque']['saldoVirtualTotal'] > 0 %}
                      Disponível ({{ produto['estoque']['saldoVirtualTotal'] }})
                    {% else %}
                      Indisponível
                    {% endif %}
                  </span>
                </p>

                {# Formulário para adicionar ao carrinho #}
                <form class="add-to-cart-form mt-auto" method="POST" action="{{ url_for('adicionar_ao_carrinho') }}"> {# mt-auto para empurrar para baixo #}
                  <input type="hidden" name="produto_id" value="{{ produto.id }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <div class="input-group input-group-sm"> {# Usar input-group sm para tamanho menor #}
                      <input type="number"
                             name="quantidade"
                             class="form-control quantity-input"
                             value="1"
                             min="1"
                             max="{{ produto.estoque.saldoVirtualTotal if produto.estoque.saldoVirtualTotal > 0 else 1 }}" {# Define max=1 se estoque 0 #}
                             aria-label="Quantidade"
                             style="max-width: 70px;" {# Limita largura do input #}
                             {{ 'disabled' if produto.estoque.saldoVirtualTotal <= 0 }}>

                      <button type="submit"
                              class="btn btn-primary cart-btn flex-grow-1" {# flex-grow-1 para ocupar espaço restante #}
                              style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" {# Evita quebra de texto no botão #}
                              {{ 'disabled' if produto.estoque.saldoVirtualTotal <= 0 }}>
                          <i class="bi bi-cart-plus"></i>
                          {{ 'Adicionar' if produto.estoque.saldoVirtualTotal > 0 else 'Indisponível' }} {# Texto mais curto #}
                      </button>
                  </div>
                </form>
                {# Fim do formulário #}

              </div>
            </div>
        </div>
        {% else %}
          {# Exibe mensagem genérica se a lista 'produtos' estiver vazia E a mensagem específica não foi exibida #}
          {% if not message %}
          <div class="col-12">
              <div class="alert alert-secondary text-center" role="alert">
                  <p class="mb-0"><i class="bi bi-info-circle me-2"></i>Nenhum produto para exibir no momento.</p>
              </div>
          </div>
          {% endif %}
        {% endfor %}
        {# Fim do loop de produtos #}
      </div>

      {% if total_paginas > 1 %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
          {% if pagina > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('index', pagina=pagina-1, search=request.args.get('search', '')) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% endif %}

          {% for p in range(1, total_paginas+1) %}
            <li class="page-item {% if p == pagina %}active{% endif %}">
              <a class="page-link" href="{{ url_for('index', pagina=p, search=request.args.get('search', '')) }}">{{ p }}</a>
            </li>
          {% endfor %}

          {% if pagina < total_paginas %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('index', pagina=pagina+1, search=request.args.get('search', '')) }}" aria-label="Próximo">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>

    <div id="toastSuccess" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
      <div class="d-flex">
        <div class="toast-body">Produto adicionado com sucesso!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>

    <div id="toastError" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
      <div class="d-flex">
        <div class="toast-body" id="toastErrorMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Script para adicionar ao carrinho (mantido como no original)
      document.addEventListener('DOMContentLoaded', function() {
          const forms = document.querySelectorAll('.add-to-cart-form');
          const toastSuccess = new bootstrap.Toast(document.getElementById('toastSuccess'));
          const toastError = new bootstrap.Toast(document.getElementById('toastError'));
          // Referência global ao contador do carrinho na navbar
          const globalCartCounter = document.querySelector('.navbar .badge.bg-danger'); // Seleciona o badge na navbar

          forms.forEach(form => {
              form.addEventListener('submit', function(e) {
                  e.preventDefault();
                  const produtoId = form.querySelector('input[name="produto_id"]').value;
                  const quantityInput = form.querySelector('.quantity-input');
                  const button = form.querySelector('.cart-btn');

                  fetch(form.action, {
                      method: 'POST',
                      body: new FormData(form),
                      headers: {
                          'X-CSRFToken': form.querySelector('input[name="csrf_token"]').value
                      }
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          toastSuccess.show();

                          // Atualiza o contador do carrinho na navbar
                          if (globalCartCounter) {
                              globalCartCounter.textContent = data.cart_total_items;
                               // Mostra o badge se estava escondido
                              if (data.cart_total_items > 0) {
                                   globalCartCounter.style.display = '';
                              }
                          }

                          // Atualiza estoque no card do produto
                          const stockElement = document.querySelector(`[data-produto-id="${produtoId}"] .badge`);
                          if (stockElement && data.estoque_disponivel !== undefined) {
                              stockElement.textContent = `Disponível (${data.estoque_disponivel})`;
                              if (data.estoque_disponivel <= 0) {
                                  stockElement.classList.remove('bg-success');
                                  stockElement.classList.add('bg-danger', 'text-white'); // Usa danger agora
                                  stockElement.textContent = 'Indisponível';
                                  button.disabled = true;
                                  button.innerHTML = '<i class="bi bi-cart-plus"></i> Indisponível';
                                  quantityInput.disabled = true;
                              } else {
                                  quantityInput.max = data.estoque_disponivel;
                                  // Garante que o botão esteja habilitado e com texto correto
                                  button.disabled = false;
                                  button.innerHTML = '<i class="bi bi-cart-plus"></i> Adicionar';
                                  quantityInput.disabled = false;
                              }
                          }
                      } else {
                          document.getElementById('toastErrorMessage').textContent = data.message || 'Erro ao adicionar'; // Usa msg do backend
                          toastError.show();

                          // Atualiza estoque mesmo em caso de erro (ex: estoque insuficiente)
                          if (data.estoque_disponivel !== undefined) {
                              quantityInput.max = data.estoque_disponivel;
                              if (data.estoque_disponivel <= 0) {
                                  button.disabled = true;
                                  button.innerHTML = '<i class="bi bi-cart-plus"></i> Indisponível';
                                  quantityInput.disabled = true;
                                  const stockElement = document.querySelector(`[data-produto-id="${produtoId}"] .badge`);
                                  if (stockElement) {
                                       stockElement.classList.remove('bg-success');
                                       stockElement.classList.add('bg-danger', 'text-white');
                                       stockElement.textContent = 'Indisponível';
                                  }
                              } else {
                                 // Mantém habilitado se ainda há estoque
                                 button.disabled = false;
                                 button.innerHTML = '<i class="bi bi-cart-plus"></i> Adicionar';
                                 quantityInput.disabled = false;
                              }
                          }
                      }
                  })
                  .catch(error => {
                      console.error('Erro:', error);
                      document.getElementById('toastErrorMessage').textContent = 'Erro na conexão com o servidor';
                      toastError.show();
                  });
              });
          });

           // Esconde o badge do carrinho se o total for 0 ao carregar a página
          if (globalCartCounter && parseInt(globalCartCounter.textContent || '0') === 0) {
               globalCartCounter.style.display = 'none';
          }

      });
    </script>
  </body>
</html>